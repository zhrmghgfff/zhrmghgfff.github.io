<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/28/iOS-Runtime%E6%8E%A2%E7%A9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/28/iOS-Runtime%E6%8E%A2%E7%A9%B6/" itemprop="url">iOS Runtimeæ¢ç©¶</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-28T23:28:10+08:00">
                2020-05-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>ä½¿ç”¨ Objective-C å¼€å‘ iOS åº”ç”¨å¾ˆå¤šå¹´äº†ï¼Œä¸€è‡´æ‰“äº¤é“çš„éƒ½æ˜¯UIéƒ¨åˆ†ï¼Œå¹³æ—¶çœ‹æ–‡ç« ä¹Ÿç»å¸¸ä¼šæœ‰ runtime çš„å­—çœ¼è·³å‡ºæ¥ï¼Œä¹ŸçŸ¥é“ä¸€äº› runtime çš„ç›¸å…³å†…å®¹ï¼Œä¾‹å¦‚æ¶ˆæ¯å‘é€ã€æ¶ˆæ¯è½¬å‘ã€æ¶ˆæ¯æ›¿æ¢ï¼Œå¹³æ—¶äº¤æµä¸­ä¹Ÿèƒ½è¯´ä¸Šæ¥ä¸ªä¸€äºŒï¼Œä½†æ˜¯æ€»ä½“çš„å°è±¡è¿˜æ˜¯æ··æ²Œæ¨¡ç³Šçš„ï¼Œä¸€ç›´æ²¡æœ‰ç»†è‡´çš„é™ä¸‹å¿ƒæ¥ï¼Œå»äº†è§£ runtime , äº†è§£runtimeæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œé‚£äº›åŠŸèƒ½æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<blockquote>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥</p>
</blockquote>
</blockquote>
<h1 id="ä»€ä¹ˆæ˜¯Runtime"><a href="#ä»€ä¹ˆæ˜¯Runtime" class="headerlink" title="ä»€ä¹ˆæ˜¯Runtime"></a>ä»€ä¹ˆæ˜¯Runtime</h1><p>å…·ä½“äº†è§£è¿˜æ˜¯å¾—çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œ<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048-CH1-SW1" target="_blank" rel="noopener">Objective-C Runtime Programming Guide</a>ï¼Œè™½ç„¶æ–‡æ¡£ä¸æ›´æ–°äº†ï¼Œä½†æ˜¯æè¿°è¿˜æ˜¯å¯ä»¥çœ‹çœ‹çš„ã€‚</p>
<blockquote>
<p>The Objective-C language defers as many decisions as it can from compile time and link time to runtime. Whenever possible, it does things dynamically. This means that the language requires not just a compiler, but also a runtime system to execute the compiled code. The runtime system acts as a kind of operating system for the Objective-C language; itâ€™s what makes the language work.</p>
</blockquote>
<p>ç¡¬æ ¸ç¿»è¯‘ä¸€ä¸‹:-) </p>
<blockquote>
<p>Objective-Cè¯­è¨€å°½å¯èƒ½åœ°å°†ç¼–è¯‘æ—¶é—´å’Œé“¾æ¥æ—¶é—´æ¨è¿Ÿåˆ°è¿è¡Œæ—¶ã€‚åªè¦æœ‰å¯èƒ½ï¼Œå®ƒå°±ä¼šåŠ¨æ€åœ°æ‰§è¡Œæ“ä½œã€‚è¿™æ„å‘³ç€è¯¥è¯­è¨€ä¸ä»…éœ€è¦ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œè¿˜éœ€è¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿæ¥æ‰§è¡Œç¼–è¯‘åçš„ä»£ç ã€‚è¿è¡Œæ—¶ç³»ç»Ÿ <strong>runtime</strong> ä½œä¸ºObjective-Cè¯­è¨€çš„ä¸€ç§æ“ä½œç³»ç»Ÿ;å®ƒä½¿Objective-Cè¯­è¨€çš„åŠ¨æ€ç‰¹æ€§ç”Ÿæ•ˆã€‚</p>
</blockquote>
<p>ç®€å•ç»„ç»‡ä¸€ä¸‹å°±æ˜¯ï¼š</p>
<ul>
<li><strong>runtime</strong> æ˜¯ä¸€ä¸ªç³»ç»Ÿï¼Œé€šè¿‡è¿™ä¸ªç³»ç»Ÿï¼ŒObjective-C å¯ä»¥å°†ä¸€äº›å†³è®®ï¼Œæ”¾åˆ°è¿è¡Œæ—¶æ¥å¤„ç†ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘ã€é“¾æ¥æ—¶å°±å®šæ­»äº†ã€‚è¿™æ ·åœ¨è¿è¡Œæ—¶å¤„ç†å†³è®®çš„ç‰¹æ€§ï¼Œå°±æ˜¯ Objective-C çš„åŠ¨æ€ç‰¹æ€§ã€‚</li>
</ul>
<blockquote>
<p>PS:è‹±æ–‡æ°´å¹³ä¸å¥½çš„ï¼Œå¯ä»¥å…ˆgoogleç¿»è¯‘ï¼Œç„¶åå†çœ‹åŸæ–‡ï¼Œå‘ç°ç¿»è¯‘å¤§éƒ¨åˆ†æ—¶å€™ï¼Œéƒ½æ˜¯ç‹—å±ä¸é€šğŸ˜¹</p>
</blockquote>
<p>æ¥ä¸‹æ¥ç»§ç»­é˜…è¯»æ–‡æ¡£ï¼Œå‘ç°æœ‰å‡ ç« ä»‹ç»Rumtime:</p>
<ul>
<li>Runtime Versions and Platforms : <strong>runtimeçš„ç‰ˆæœ¬ä¸å¹³å°</strong></li>
<li>Interacting with the Runtime : <strong>ä¸runtimeçš„äº¤äº’</strong></li>
<li>Messaging : <strong>æ¶ˆæ¯ä¼ é€’</strong></li>
<li>Dynamic Method Resolution : <strong>åŠ¨æ€æ–¹æ³•è§£æ</strong></li>
<li>Message Forwarding : <strong>æ¶ˆæ¯è½¬å‘</strong></li>
<li>Type Encodings : <strong>ç±»å‹ç¼–ç </strong></li>
<li>Declared Properties : <strong>å£°æ˜å±æ€§</strong></li>
</ul>
<blockquote>
<p>è¿™å‡ ç« åŸºæœ¬ä»‹ç»äº† runtime ç›¸å…³åŠŸèƒ½ï¼Œç›¸å½“äºä¸€ä¸ªæ€»çº²ï¼Œæ¯å½“æ²¡æœ‰å¤´ç»ªçš„æ—¶å€™éƒ½å¯ä»¥å›æ¥çœ‹çœ‹</p>
</blockquote>
<p>åœ¨<code>ä¸runtimeçš„äº¤äº’</code>è¿™ç« ä¸­ï¼Œå‘ç°ä¸‰ä¸ªä¸ runtime ç³»ç»Ÿäº¤äº’çš„é€”å¾„ï¼š</p>
<ul>
<li>through Objective-C source code : <strong>é€šè¿‡ Objective-C æºç </strong></li>
<li>through methods defined in the NSObject class of the Foundation framework : <strong>é€šè¿‡ Foundation æ¡†æ¶ä¸­çš„ NSObject ç±»ä¸­å®šä¹‰çš„æ–¹æ³•</strong></li>
<li>through direct calls to runtime functions : <strong>ç›´æ¥é€šè¿‡ runtime çš„æ–¹æ³•</strong></li>
</ul>
<p>æ¥ä¸‹æ¥é˜…è¯»ç›¸å…³å†…å®¹å‘ç°ï¼Œ<strong>runtime</strong> å…¶å®æ˜¯ä¸€ä¸ª<strong>åŠ¨æ€å…±äº«åº“</strong> ï¼ˆçœŸå®åå­—æ˜¯libobjcï¼‰ï¼Œä¸€èˆ¬æ”¾åœ¨<code>/usr/include/objc</code>ä¸‹ï¼Œruntime ç›¸å…³çš„æ–¹æ³•å¯ä»¥å‚è€ƒ<a href="https://developer.apple.com/documentation/objectivec/objective-c_runtime?language=objc" target="_blank" rel="noopener">Objective-C Runtime Reference</a>ï¼Œé‡Œé¢ä»‹ç»äº†æ‰€æœ‰çš„è¿è¡Œæ—¶æ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬è¦ç ”ç©¶ runtime å¦‚ä½•åŠ è½½ï¼Œå¦‚ä½•å¤„ç†ï¼Œåªçœ‹ä»‹ç»ï¼Œè¿˜æ˜¯æœ‰ç‚¹è™šï¼Œæœ‰ä¸€ä¸ªç¨‹åºå‘˜è¯´ï¼š<code>Talk is cheap. Show me the code.</code>ï¼Œçœ‹æºç æ‰èƒ½çœŸåˆ‡çš„çŸ¥é“ã€äº†è§£ï¼Œå®ƒæ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<blockquote>
<p>å¦‚æœå»æŸ¥æ‰¾æºç ï¼Ÿ</p>
</blockquote>
<h1 id="Runtime-æºç "><a href="#Runtime-æºç " class="headerlink" title="Runtime æºç "></a>Runtime æºç </h1><p>è‹¹æœæœ‰ä¸“é—¨çš„æºç å¼€æºç½‘å€ï¼š<a href="https://opensource.apple.com/" target="_blank" rel="noopener">opensource</a>,é€‰æ‹©ä¸€ä¸ªMac ç³»ç»Ÿç‰ˆæœ¬ï¼Œç‚¹è¿›å»ï¼Œå‘ç°æœ‰å¥½å¤šåº“ï¼Œæœç´¢<code>objc</code>ï¼Œæ‰¾ä¸€ä¸ª<code>objc</code>ï¼Œåé¢çš„æ•°å­—æ˜¯ä»–çš„ç‰ˆæœ¬ï¼Œç„¶åä¸‹è½½ï¼Œè§£å‹ï¼Œå°±æ‹¿åˆ° <strong>runtime</strong> çš„æºç äº†ã€‚</p>
<p>è§£å‹åï¼Œè¿›å…¥æºç æ–‡ä»¶å¤¹ï¼ˆæˆ‘ä¸‹è½½çš„æ˜¯ <strong>objc4-781.2</strong>ï¼‰ï¼Œæ‰“å¼€ <strong>objc.xcodeproj</strong>ï¼Œå°±å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„æºç è§£æä¹‹è·¯äº†ã€‚</p>
<h2 id="ç¼–è¯‘-objc-æºç "><a href="#ç¼–è¯‘-objc-æºç " class="headerlink" title="ç¼–è¯‘ objc æºç "></a>ç¼–è¯‘ objc æºç </h2><p>ä¸ºäº†è·Ÿè¸ªä»£ç è¿è¡Œï¼Œæœ€å¥½è¿˜æ˜¯ç¼–è¾‘ä¸‹æºç ï¼Œå®é™…è°ƒè¯•è·Ÿè¸ªæ–¹æ³•çš„è¿è¡Œï¼Œæ›´å¥½ç†è§£æ•´ä¸ª <strong>runtime</strong> çš„å®ç°ã€‚</p>
<h3 id="ç¼–è¯‘ä¸­é‡åˆ°çš„é—®é¢˜"><a href="#ç¼–è¯‘ä¸­é‡åˆ°çš„é—®é¢˜" class="headerlink" title="ç¼–è¯‘ä¸­é‡åˆ°çš„é—®é¢˜"></a>ç¼–è¯‘ä¸­é‡åˆ°çš„é—®é¢˜</h3><h4 id="unable-to-find-SDK-â€˜macosx-internalâ€˜"><a href="#unable-to-find-SDK-â€˜macosx-internalâ€˜" class="headerlink" title="unable to find SDK â€˜macosx.internalâ€˜"></a>unable to find SDK â€˜<strong>macosx.internal</strong>â€˜</h4><p>éœ€è¦ macOS çš„ SDKï¼Œç›´æ¥åœ¨å·¥ç¨‹é‡Œé¢ä¿®æ”¹é…ç½®ï¼Œ<code>Build Settings</code> -&gt; <code>Base SDK</code> ï¼Œ é€‰æ‹©å½“å‰çš„ç³»ç»Ÿçš„Mac OS SDKï¼Œæˆ‘çš„ç³»ç»Ÿæ˜¯<code>10.15.4</code>ï¼Œå°±é€‰æ‹©<code>macOS 10.15</code></p>
<h4 id="â€˜sys-reason-hâ€˜-file-not-found"><a href="#â€˜sys-reason-hâ€˜-file-not-found" class="headerlink" title="â€˜sys/reason.hâ€˜ file not found"></a>â€˜<strong>sys/reason.h</strong>â€˜ file not found</h4><p>ç¼ºå°‘ <code>sys</code> ç›¸å…³çš„å¤´æ–‡ä»¶ï¼Œè¿™äº›å¤´æ–‡ä»¶å…¶å®æ˜¯ <a href="https://zh.wikipedia.org/wiki/XNU" target="_blank" rel="noopener">è‹¹æœç³»ç»Ÿå†…æ ¸ XNU</a> çš„å¤´æ–‡ä»¶ï¼ŒåŒæ ·çš„å¯ä»¥å» <a href="https://opensource.apple.com/" target="_blank" rel="noopener">opensource</a> ä¸Šï¼Œä¸‹è½½åˆ° <code>xnu</code> (ä¸‹è½½ä¸ <strong>objc</strong> åŒä¸€ç›®å½•ä¸‹ <strong>xnu</strong> å³å¯)ï¼Œåœ¨å·¥ç¨‹é‡Œé¢ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå°†ç¼ºå°‘çš„æ–‡ä»¶å¤åˆ¶è¿›å»ã€‚</p>
<blockquote>
<p>PSï¼šå·¥ç¨‹ä¸‹çš„æ–°å»ºç›®å½•ï¼Œä¾‹å¦‚æ–°å»ºçš„ç›®å½•ä¸º <strong>Commons</strong>ï¼Œæ–°å»º <strong>sys</strong> ç›®å½•ï¼Œæ”¾ç½® <strong>sys</strong> ä¸‹çš„æ–‡ä»¶ï¼Œæœ€åæ·»åŠ å¤´æ–‡ä»¶çš„æœç´¢è·¯å¾„ä¸º <code>$(SRCROOT)/Commons</code>ã€‚å…¶ä»–çš„æ–‡ä»¶ç¼ºå¤±é—®é¢˜ï¼ŒåŒç†æ“ä½œã€‚</p>
</blockquote>
<p>å¯ä»¥é€šè¿‡è°·æ­Œä¸­è¾“å…¥<code>reason.h site:opensource.apple.com</code> å®šå‘æ£€ç´¢ï¼Œæ–‡ä»¶åœ¨å“ªä¸ªåº“é‡Œé¢ã€‚<br>ä¾æ¬¡éœ€è¦ä¸‹è½½çš„åº“ä¸ºï¼š<code>xnu</code>ï¼Œ<code>dyld</code>ï¼Œ<code>libplatform</code>ï¼Œ<code>libpthread</code>ï¼Œ<code>libc (825ç‰ˆæœ¬)</code></p>
<p>ä¸€äº›æ–‡ä»¶éœ€è¦ç‰¹æ®Šå¤„ç†ï¼š</p>
<ul>
<li><p>dyld_priv.h   å»æ‰ bridgeos(3.0) </p>
<ul>
<li>bridgeOSæ˜¯watchOSçš„ç»è¿‡é‡å¤§ä¿®æ”¹çš„å˜ä½“ï¼Œå¯åœ¨é›†æˆçš„iBridgeè®¾å¤‡ä¸Šè¿è¡Œã€‚</li>
<li>iBridgeæ˜¯Macçš„åµŒå…¥å¼å¤„ç†è®¾å¤‡ç³»åˆ—ã€‚å½“å‰æœ‰ä¸¤ä¸ªä¸»è¦å˜ä½“ã€‚<ul>
<li>iBridge T1-åœ¨2016å¹´å¸¦Touch Barçš„MacBook Proä¸­å‘ç°ã€‚</li>
<li>iBridge T2-åœ¨iMac Proå’Œæ›´é«˜ç‰ˆæœ¬ä¸­æ‰¾åˆ°ã€‚</li>
</ul>
</li>
<li>è·Ÿæˆ‘æ¢ç©¶runtimeå…³ç³»ä¸å¤§ï¼Œç›´æ¥å»æ‰</li>
</ul>
</li>
<li><p>lock_private.h  å»æ‰ bridgeos(4.0) </p>
</li>
<li><p>CrashReporterClient.h å¢åŠ å®å®šä¹‰<br><code>#define LIBC_NO_LIBCRASHREPORTERCLIENT</code></p>
</li>
</ul>
<ul>
<li>pthread_machdep.h<br>  è¿™ä¸ªå¤´æ–‡ä»¶æ˜¯åœ¨libc(825ç‰ˆæœ¬)ä¸­çš„ï¼Œ825ä¹‹åçš„ç‰ˆæœ¬ï¼Œå·²ç»æ²¡æœ‰æ­¤æ–‡ä»¶äº†ï¼Œè·Ÿ objcå¯¹åº”libcåº“ï¼Œç‰ˆæœ¬æ¯”825é«˜ï¼Œä¼šå‡ºç°ä¸€äº›é‡å¤å®šä¹‰çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ä¸€äº›å®ï¼Œè¿˜æœ‰å‡½æ•°ï¼Œç›´æ¥æ³¨é‡Šæ‰pthread_machdep.hçš„å®šä¹‰å³å¯ã€‚</li>
</ul>
<h4 id="Use-of-undeclared-identifier-â€˜DYLD-MACOSX-VERSION-10-13â€™"><a href="#Use-of-undeclared-identifier-â€˜DYLD-MACOSX-VERSION-10-13â€™" class="headerlink" title="Use of undeclared identifier â€˜DYLD_MACOSX_VERSION_10_13â€™"></a>Use of undeclared identifier â€˜<strong>DYLD_MACOSX_VERSION_10_13</strong>â€™</h4><p>è¿™æ˜¯MacOSå¯¹åº”çš„ç‰ˆæœ¬å®ï¼Œå®šä¹‰ä¸€ä¸‹å³å¯ï¼ŒgoogleæŸ¥æ‰¾åˆ°çš„<a href="https://docs.rs/goblin/0.0.13/i686-pc-windows-msvc/goblin/mach/constants/" target="_blank" rel="noopener">ç‰ˆæœ¬ä¿¡æ¯</a></p>
<ul>
<li>dyld_priv.h</li>
</ul>
<blockquote>
<p>å®å®šä¹‰ä¹ æƒ¯å†™æˆ16è¿›åˆ¶<br><code>#define DYLD_MACOSX_VERSION_10_11 0x000A0B00</code><br><code>#define DYLD_MACOSX_VERSION_10_12 0x000A0C00</code><br><code>#define DYLD_MACOSX_VERSION_10_13 0x000A0D00</code><br><code>#define DYLD_MACOSX_VERSION_10_14 0x000A0E00</code></p>
</blockquote>
<h4 id="canâ€™t-open-order-file-libobjc-order"><a href="#canâ€™t-open-order-file-libobjc-order" class="headerlink" title="canâ€™t open order file: libobjc.order"></a>canâ€™t open order file: <strong>libobjc.order</strong></h4><p>ä¿®æ”¹å·¥ç¨‹é…ç½®ï¼Œæ·»åŠ <code>libobjc.order</code>çš„è·¯å¾„ï¼Œ<code>target</code> -&gt; <code>objc</code> -&gt; <code>Build Settings</code>ï¼Œ<code>Order file</code> -&gt; <code>$(SRCROOT)/libobjc.order</code></p>
<h4 id="Library-not-found-for-lCrashReporterClient"><a href="#Library-not-found-for-lCrashReporterClient" class="headerlink" title="Library not found for -lCrashReporterClient"></a>Library not found for <strong>-lCrashReporterClient</strong></h4><p>æˆ‘ä»¬ä¸éœ€è¦å´©æºƒä¸ŠæŠ¥ï¼Œä¿®æ”¹é…ç½®å»æ‰<code>-lCrashReporterClient</code>ï¼Œåœ¨ <code>target</code> -&gt; <code>objc</code> -&gt; <code>Build Settings</code> -&gt; <code>Linking</code> -&gt; <code>Other Linker Flags</code>ï¼Œåˆ é™¤æ‰€æœ‰çš„<code>-lCrashReporterClient</code></p>
<h4 id="SDK-â€œmacosx-internalâ€-cannot-be-located"><a href="#SDK-â€œmacosx-internalâ€-cannot-be-located" class="headerlink" title="SDK â€œmacosx.internalâ€ cannot be located."></a>SDK â€œmacosx.internalâ€ cannot be located.</h4><p>buildè„šæœ¬å‡ºç°äº†é—®é¢˜ï¼Œåœ¨ <code>target</code> -&gt; <code>objc</code> -&gt; <code>Build Phases</code> -&gt; <code>Run Script(markgc)</code>ä¸­ï¼Œä¿®æ”¹ <code>macosx.internal</code> ä¸º <code>macosx</code>ã€‚</p>
<h3 id="ç¼–è¯‘æˆåŠŸã€‚"><a href="#ç¼–è¯‘æˆåŠŸã€‚" class="headerlink" title="ç¼–è¯‘æˆåŠŸã€‚"></a>ç¼–è¯‘æˆåŠŸã€‚</h3><h2 id="æ–°å»ºè°ƒè¯•çš„Target"><a href="#æ–°å»ºè°ƒè¯•çš„Target" class="headerlink" title="æ–°å»ºè°ƒè¯•çš„Target"></a>æ–°å»ºè°ƒè¯•çš„Target</h2><p>é€‰æ‹© <code>macOS</code> -&gt; <code>Application</code> -&gt; <code>Command Line Tool</code>ï¼Œå‘½åä¸º<code>TestRuntime</code><br>å…³è” <strong>objc</strong> åº“ï¼š</p>
<ul>
<li><code>target</code> -&gt; <code>TestRuntime</code> -&gt; <code>Build Phases</code> -&gt; <code>Dependencies</code>ï¼Œæ·»åŠ ä¾èµ– <code>objc</code>ã€‚</li>
<li><code>target</code> -&gt; <code>TestRuntime</code> -&gt; <code>Build Phases</code> -&gt; <code>Link Binary With Libraries</code>ï¼Œæ·»åŠ  <code>libobjc.A.dylib</code></li>
</ul>
<blockquote>
<p>åœ¨Xcode 11ä¸­ï¼Œé»˜è®¤çš„ target æ˜¯æ²¡æœ‰æƒé™è¿›è¡Œæ–­ç‚¹è°ƒè¯•çš„ï¼Œéœ€è¦ä¿®æ”¹é…ç½®ï¼Œ<code>target</code> -&gt; <code>objc</code> -&gt; <code>Build Settings</code> -&gt; <code>Enable Hardened Runtime</code> -&gt; <code>NO</code></p>
</blockquote>
<h3 id="å¯åŠ¨ï¼Œæ–­ç‚¹æˆåŠŸ"><a href="#å¯åŠ¨ï¼Œæ–­ç‚¹æˆåŠŸ" class="headerlink" title="å¯åŠ¨ï¼Œæ–­ç‚¹æˆåŠŸ"></a>å¯åŠ¨ï¼Œæ–­ç‚¹æˆåŠŸ</h3><p>è¿™æ ·å°±å¯ä»¥å°±è¡Œè°ƒè¯•äº†ã€‚</p>
<h3 id="ç›´æ¥æ–­ç‚¹è¿›å…¥-objc-æºä»£ç "><a href="#ç›´æ¥æ–­ç‚¹è¿›å…¥-objc-æºä»£ç " class="headerlink" title="ç›´æ¥æ–­ç‚¹è¿›å…¥ objc æºä»£ç "></a>ç›´æ¥æ–­ç‚¹è¿›å…¥ objc æºä»£ç </h3><p>ç›´æ¥æ–°å»º <code>iOS App</code>ï¼Œè¿›è¡Œä»£ç è°ƒè¯•ï¼Œç›®å‰è¿˜åšä¸åˆ°ï¼Œæœ‰å¥½å¤šé”™è¯¯ï¼Œåç»­å†è¿›è¡Œè¡¥å……ã€‚<code>step by step</code>è·Ÿè¸ªä»£ç è¿è¡Œï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£ä»£ç åŸç†ã€‚ä¸èƒ½çš„è¯ï¼Œå°±åªèƒ½ä¾é ä»£ç ç»éªŒæ¥ç†è§£äº†ï¼Œéš¾åº¦ä¸Šå‡äº†ä¸€äº›ã€‚</p>
<h1 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><p>æ¥ä¸‹æ¥å°±å¼€å§‹æºç è§£æäº†ã€‚å…ˆä»æ„Ÿå…´è¶£çš„åœ°æ–¹å¼€å§‹ï¼Œç¬¬ä¸€ä¸ªé€‰æ‹© <code>objc_msgSend</code>ï¼Œè¿™æ˜¯ <code>runtime</code> çš„ç²¾é«“æ‰€åœ¨ã€‚</p>
<blockquote>
<p>æºç ç‰ˆæœ¬ <code>objc4-781.2</code>ï¼Œç‰ˆæœ¬ä¸åŒï¼Œå…·ä½“çš„å®ç°ä¼šæœ‰å·®å¼‚ï¼Œè¯·æ³¨æ„ã€‚</p>
</blockquote>
<h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h2><p><code>objc_msgSend</code>ï¼ŒObjective-C ä¸­æ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œéƒ½æ˜¯ç”±å®ƒæ¥è¿›è¡Œé—´æ¥è°ƒç”¨çš„ã€‚è§£æ<code>objc_msgSend</code>ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°å®ƒçš„å®ç°ã€‚</p>
<h3 id="æ€ä¹ˆæ‰¾åˆ°objc-msgSendçš„å®ç°ï¼Ÿ"><a href="#æ€ä¹ˆæ‰¾åˆ°objc-msgSendçš„å®ç°ï¼Ÿ" class="headerlink" title="æ€ä¹ˆæ‰¾åˆ°objc_msgSendçš„å®ç°ï¼Ÿ"></a>æ€ä¹ˆæ‰¾åˆ°objc_msgSendçš„å®ç°ï¼Ÿ</h3><p>åœ¨è°ƒè¯•çš„Targetä¸­ï¼Œåœ¨mainå‡½æ•°ä¸­ï¼Œéšä¾¿æ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨å®ƒçš„æ–¹æ³•ï¼Œç„¶åè¿›è¡Œæ–­ç‚¹ï¼š<br><img src="/images/%E6%88%AA%E5%B1%8F2020-06-01_%E4%B8%8B%E5%8D%881.55.40.png" alt=""></p>
<p>è¿è¡Œç¨‹åºï¼Œåœ¨æ–­ç‚¹å¤„ä¸­æ–­ï¼Œç„¶åæŒ‰ä½<code>ctrl</code>é”®ï¼ŒæŒ‰f7ï¼ˆå…¶å®å°±æ˜¯ <code>debug</code> ä¸‹çš„ <code>Step Into Instruction</code>çš„å¿«æ·é”®ï¼‰ï¼Œæ–­ç‚¹å¤„ä¼šä¸€ç›´é—ªçƒï¼Œç»§ç»­æŒ‰ï¼Œç›´åˆ°è·³è½¬åˆ°ä¸€ä¸ªæ–°çš„é¡µé¢ã€‚<br><img src="/images/%E6%88%AA%E5%B1%8F2020-06-01_%E4%B8%8B%E5%8D%882.06.08.png" alt=""></p>
<ul>
<li>ä¸Šå›¾ <strong>1</strong> å¤„ï¼Œå¯ä»¥çœ‹åˆ°<code>ENTRY _objc_msgSend</code>ï¼Œè¿™å°±æ˜¯ <code>objc_msgSend</code> çš„ä»£ç å®ç°ï¼Œè€Œä¸”è¿˜æ˜¯æ±‡ç¼–å†™ã€‚</li>
<li>ä¸Šå›¾ <strong>2</strong> å¤„ï¼Œ<code>objc-msg-x86_64.s</code>ï¼Œè¡¨ç¤ºæ­¤æ±‡ç¼–æ–‡ä»¶ï¼Œæ˜¯ä¸º <code>x86_64</code> å¹³å°ç¼–å†™çš„ï¼Œå› ä¸ºæˆ‘çš„è°ƒè¯•ç¨‹åºæ˜¯ <code>macOS Command Line Tool</code>ã€‚</li>
</ul>
<blockquote>
<p><code>ENTRY</code> æ˜¯æ±‡ç¼–å®ç°çš„å…¥å£ï¼ŒåŒæ ·çš„è¿˜æœ‰ <code>STATIC_ENTRY</code>ï¼Œå¯¹åº”çš„å°±æ˜¯ <code>END_ENTRY</code>ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆæ€ä¹ˆæ‰¾åˆ° <code>iOS</code> ä½¿ç”¨çš„æºç çš„å‘¢ï¼Œå…¶å®ä»å‘½åä¸Šå°±å¯ä»¥ï¼Œå¾ˆå¿«æ‰¾åˆ° <code>iOS</code>ï¼ˆæœ€æ–°çš„å°±æ˜¯<code>arm64</code>ï¼‰ å¯¹åº”çš„æºç ï¼Œ<code>objc-msg-arm64.s</code>ï¼Œç„¶åæœç´¢ <code>ENTRY _objc_msgSend</code>ï¼Œå°±æ‰¾åˆ°äº† <code>_objc_msgSend</code> çš„å®ç°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æºç çš„åˆ†æäº†ã€‚</p>
<h3 id="objc-msgSend-æºç åˆ†æ"><a href="#objc-msgSend-æºç åˆ†æ" class="headerlink" title="_objc_msgSend æºç åˆ†æ"></a>_objc_msgSend æºç åˆ†æ</h3><h4 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	ENTRY _objc_msgSend</span><br><span class="line">	UNWIND _objc_msgSend, NoFrame</span><br><span class="line"></span><br><span class="line">	cmp	p0, #0			&#x2F;&#x2F; nil check and tagged pointer check nilæ£€æµ‹å’Œè¢«æ ‡è®°çš„æŒ‡é’ˆæ£€æµ‹</span><br><span class="line">#if SUPPORT_TAGGED_POINTERS</span><br><span class="line">	b.le	LNilOrTagged		&#x2F;&#x2F;  (MSB tagged pointer looks negative MSBæ ‡è®°çš„æŒ‡é’ˆçœ‹èµ·æ¥åƒæ˜¯è´Ÿçš„ )</span><br><span class="line">#else</span><br><span class="line">	b.eq	LReturnZero</span><br><span class="line">#endif</span><br><span class="line">	ldr	p13, [x0]		&#x2F;&#x2F; p13 &#x3D; isa è¯»å– isa</span><br><span class="line">	GetClassFromIsa_p16 p13		&#x2F;&#x2F; p16 &#x3D; class é€šè¿‡ isa è·å– class</span><br><span class="line">LGetIsaDone:</span><br><span class="line">	&#x2F;&#x2F; calls imp or objc_msgSend_uncached</span><br><span class="line">	CacheLookup NORMAL, _objc_msgSend &#x2F;&#x2F;é€šè¿‡ NORMAL æ¨¡å¼ï¼Œç¼“å­˜æŸ¥æ‰¾</span><br></pre></td></tr></table></figure>

<ol>
<li>é¦–å…ˆè¿›è¡Œå¯¹è±¡æŒ‡é’ˆçš„åˆ¤æ–­ï¼Œåˆ¤è¯»æ˜¯ä¸æ˜¯ç©ºæŒ‡é’ˆ</li>
<li>ä¸æ˜¯ç©ºæŒ‡é’ˆï¼Œå†è¿›è¡Œæ ‡è®°æŒ‡é’ˆçš„æ£€æµ‹ï¼Œï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œä¼šå¯¹æŒ‡é’ˆè¿›è¡Œæ ‡è®°ï¼Œç”¨äºä¿¡æ¯è°ƒè¯•ï¼‰ã€‚</li>
<li>æ˜¯ç©ºæŒ‡é’ˆï¼Œç›´æ¥èµ° <code>LReturnZero</code>ï¼Œå°±æ˜¯ç›´æ¥è¿”å›ï¼ˆæ¸…ç©ºæ®µå¯„å­˜å™¨çŠ¶æ€ï¼‰ã€‚</li>
<li>è¯»å–isa</li>
<li>é€šè¿‡ isa è·å– class</li>
<li>è¿›è¡Œç¼“å­˜æŸ¥æ‰¾ <code>CacheLookup</code>ã€‚</li>
</ol>
<h4 id="CacheLookup-ç¼“å­˜æŸ¥æ‰¾"><a href="#CacheLookup-ç¼“å­˜æŸ¥æ‰¾" class="headerlink" title="CacheLookup ç¼“å­˜æŸ¥æ‰¾"></a>CacheLookup ç¼“å­˜æŸ¥æ‰¾</h4><p>ä»£ç æœç´¢<code>CacheLookup</code>ï¼Œå‘ç°æ˜¯ä¸€ä¸ªå® <code>.macro CacheLookup</code>ï¼Œå…·ä½“å®ç°å…¨æ˜¯æ±‡ç¼–ï¼ˆæœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹ï¼Œæˆ‘æ˜¯çœ‹ä¸æ‡‚ï¼‰ï¼Œåœ¨å®å®šä¹‰çš„ä¸Šé¢æœ‰ä¸€æ®µå…³äº <code>CacheLookup</code>çš„è¯´æ˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*********************************************************************</span><br><span class="line"> *</span><br><span class="line"> * CacheLookup NORMAL|GETIMP|LOOKUP &lt;function&gt;</span><br><span class="line"> * æ¨¡å¼æœ‰ä¸‰ç§ï¼š</span><br><span class="line"> * NORMAL æ™®é€š</span><br><span class="line"> * GETIMP è·å–å®ç°</span><br><span class="line"> * LOOKUP æŸ¥æ‰¾</span><br><span class="line"> *</span><br><span class="line"> * Locate the implementation for a selector in a class method cache.</span><br><span class="line"> * åœ¨ç±»æ–¹æ³•ç¼“å­˜ä¸­æ‰¾åˆ°é€‰æ‹©å™¨çš„å®ç°ã€‚</span><br><span class="line"> *</span><br><span class="line"> * When this is used in a function that doesn&#39;t hold the runtime lock,</span><br><span class="line"> * this represents the critical section that may access dead memory.</span><br><span class="line"> * If the kernel causes one of these functions to go down the recovery</span><br><span class="line"> * path, we pretend the lookup failed by jumping the JumpMiss branch.</span><br><span class="line"> * å½“å®ƒç”¨äºä¸€ä¸ªä¸æŒæœ‰è¿è¡Œæ—¶é”çš„å‡½æ•°æ—¶ï¼Œ</span><br><span class="line"> * è¿™è¡¨ç¤ºå¯èƒ½è®¿é—®æ­»å†…å­˜çš„ä¸´ç•Œæ®µã€‚</span><br><span class="line"> * å¦‚æœå†…æ ¸å¯¼è‡´å…¶ä¸­ä¸€ä¸ªå‡½æ•°åœæ­¢æ¢å¤è·¯å¾„ï¼Œ</span><br><span class="line"> * æˆ‘ä»¬é€šè¿‡è·³è¿‡JumpMissåˆ†æ”¯æ¥å‡è£…æŸ¥æ‰¾å¤±è´¥ã€‚</span><br><span class="line"> * </span><br><span class="line"> * Takes: å¯„å­˜å™¨ä»£è¡¨çš„å‚æ•°</span><br><span class="line"> *	 x1 &#x3D; selector</span><br><span class="line"> *	 x16 &#x3D; class to be searched</span><br><span class="line"> *</span><br><span class="line"> * Kills:</span><br><span class="line"> * 	 x9,x10,x11,x12, x17</span><br><span class="line"> *</span><br><span class="line"> * On exit: (found) calls or returns IMP</span><br><span class="line"> *                  with x16 &#x3D; class, x17 &#x3D; IMP</span><br><span class="line"> *          (æ‰¾åˆ°)  å¯„å­˜å™¨x16 &#x3D; class, x17 &#x3D; IMP</span><br><span class="line"> *</span><br><span class="line"> *          (not found) jumps to LCacheMiss</span><br><span class="line"> *          (æœªæ‰¾åˆ°) è·³è½¬åˆ° LCacheMiss</span><br><span class="line"> *</span><br><span class="line"> ********************************************************************&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>æŸ¥çœ‹æ±‡ç¼–æºç ï¼Œç»“åˆè¯´æ˜ï¼Œå‘ç°ç¼“å­˜æŸ¥æ‰¾ï¼Œä¼šæœ‰ä¸‰ç§ç»“æœï¼Œ<code>CacheHit</code>ç¼“å­˜å‘½ä¸­ã€<code>CheckMiss</code>æœªæ£€æµ‹åˆ°ã€<code>JumpMiss</code>è·³è½¬å¤±è´¥ã€‚</li>
</ul>
<h5 id="CacheHit-ç¼“å­˜å‘½ä¸­"><a href="#CacheHit-ç¼“å­˜å‘½ä¸­" class="headerlink" title="CacheHit ç¼“å­˜å‘½ä¸­"></a>CacheHit ç¼“å­˜å‘½ä¸­</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; CacheHit: x17 &#x3D; cached IMP, x12 &#x3D; address of cached IMP, x1 &#x3D; SEL, x16 &#x3D; isa</span><br><span class="line">.macro CacheHit</span><br><span class="line">.if $0 &#x3D;&#x3D; NORMAL</span><br><span class="line">	TailCallCachedImp x17, x12, x1, x16	&#x2F;&#x2F; authenticate and call imp éªŒè¯å¹¶è°ƒç”¨imp</span><br><span class="line">.elseif $0 &#x3D;&#x3D; GETIMP</span><br><span class="line">	mov	p0, p17</span><br><span class="line">	cbz	p0, 9f			&#x2F;&#x2F; don&#39;t ptrauth a nil imp</span><br><span class="line">	AuthAndResignAsIMP x0, x12, x1, x16	&#x2F;&#x2F; authenticate imp and re-sign as IMP éªŒè¯impå¹¶é‡ç­¾ä¸ºimp</span><br><span class="line">9:	ret				&#x2F;&#x2F; return IMP</span><br><span class="line">.elseif $0 &#x3D;&#x3D; LOOKUP</span><br><span class="line">	&#x2F;&#x2F; No nil check for ptrauth: the caller would crash anyway when they</span><br><span class="line">	&#x2F;&#x2F; jump to a nil IMP. We don&#39;t care if that jump also fails ptrauth.</span><br><span class="line">	AuthAndResignAsIMP x17, x12, x1, x16	&#x2F;&#x2F; authenticate imp and re-sign as IMP éªŒè¯impå¹¶é‡ç­¾ä¸ºimp</span><br><span class="line">	ret				&#x2F;&#x2F; return imp via x17</span><br><span class="line">.else</span><br><span class="line">.abort oops</span><br><span class="line">.endif</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>

<ul>
<li>NORMALæ¨¡å¼ä¸‹ï¼ŒéªŒè¯å¹¶è°ƒç”¨impï¼Œ<code>TailCallCachedImp</code>æ˜¯ä¸€ä¸ªå®ã€‚</li>
<li>GETIMPæ¨¡å¼ä¸‹ï¼ŒéªŒè¯impå¹¶é‡ç­¾ä¸ºimpï¼Œè¿”å›impã€‚</li>
<li>LOOKUPæ¨¡å¼ä¸‹ï¼ŒéªŒè¯impå¹¶é‡ç­¾ä¸ºimpï¼Œè¿”å›impã€‚</li>
</ul>
<h5 id="CheckMiss-æœªæ£€æµ‹åˆ°"><a href="#CheckMiss-æœªæ£€æµ‹åˆ°" class="headerlink" title="CheckMiss æœªæ£€æµ‹åˆ°"></a>CheckMiss æœªæ£€æµ‹åˆ°</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.macro CheckMiss</span><br><span class="line">	&#x2F;&#x2F; miss if bucket-&gt;sel &#x3D;&#x3D; 0</span><br><span class="line">.if $0 &#x3D;&#x3D; GETIMP</span><br><span class="line">	cbz	p9, LGetImpMiss &#x2F;&#x2F;è·³è½¬åˆ°LGetImpMiss</span><br><span class="line">.elseif $0 &#x3D;&#x3D; NORMAL</span><br><span class="line">	cbz	p9, __objc_msgSend_uncached &#x2F;&#x2F;è·³è½¬åˆ°__objc_msgSend_uncached</span><br><span class="line">.elseif $0 &#x3D;&#x3D; LOOKUP</span><br><span class="line">	cbz	p9, __objc_msgLookup_uncached &#x2F;&#x2F;è·³è½¬åˆ°__objc_msgLookup_uncached</span><br><span class="line">.else</span><br><span class="line">.abort oops</span><br><span class="line">.endif</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>

<p>ç¼“å­˜æœªå‘½ä¸­çš„æ—¶å€™éƒ½æ˜¯ç›´æ¥çš„è·³è½¬ï¼š</p>
<ul>
<li>GETIMPæ¨¡å¼ä¸‹ï¼Œè·³è½¬åˆ° <code>LGetImpMiss</code>ï¼Œå°±æ˜¯ç›´æ¥è¿”å›äº†ã€‚</li>
<li>NORMALæ¨¡å¼ä¸‹ï¼Œè·³è½¬åˆ° <code>__objc_msgSend_uncached</code>ï¼Œé€šè¿‡éç¼“å­˜çš„æ–¹å¼ï¼Œå‘é€æ¶ˆæ¯ã€‚</li>
<li>LOOKUPæ¨¡å¼ä¸‹ï¼Œè·³è½¬åˆ° <code>__objc_msgLookup_uncached</code>ï¼Œé€šè¿‡éç¼“å­˜çš„æ–¹å¼ï¼ŒæŸ¥æ‰¾impã€‚</li>
</ul>
<h5 id="JumpMissè·³è½¬å¤±è´¥"><a href="#JumpMissè·³è½¬å¤±è´¥" class="headerlink" title="JumpMissè·³è½¬å¤±è´¥"></a>JumpMissè·³è½¬å¤±è´¥</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.macro JumpMiss</span><br><span class="line">.if $0 &#x3D;&#x3D; GETIMP</span><br><span class="line">	b	LGetImpMiss</span><br><span class="line">.elseif $0 &#x3D;&#x3D; NORMAL</span><br><span class="line">	b	__objc_msgSend_uncached</span><br><span class="line">.elseif $0 &#x3D;&#x3D; LOOKUP</span><br><span class="line">	b	__objc_msgLookup_uncached</span><br><span class="line">.else</span><br><span class="line">.abort oops</span><br><span class="line">.endif</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>

<p>å¤„ç†åŸºæœ¬è·Ÿ <code>CheckMiss</code> ä¸€è‡´</p>
<h4 id="objc-msgSend-uncached-é€šè¿‡éç¼“å­˜çš„æ–¹å¼ï¼Œå‘é€æ¶ˆæ¯"><a href="#objc-msgSend-uncached-é€šè¿‡éç¼“å­˜çš„æ–¹å¼ï¼Œå‘é€æ¶ˆæ¯" class="headerlink" title="__objc_msgSend_uncached é€šè¿‡éç¼“å­˜çš„æ–¹å¼ï¼Œå‘é€æ¶ˆæ¯"></a>__objc_msgSend_uncached é€šè¿‡éç¼“å­˜çš„æ–¹å¼ï¼Œå‘é€æ¶ˆæ¯</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ENTRY __objc_msgSend_uncached</span><br><span class="line">UNWIND __objc_msgSend_uncached, FrameWithNoSaves</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; THIS IS NOT A CALLABLE C FUNCTION</span><br><span class="line">&#x2F;&#x2F; Out-of-band p16 is the class to search</span><br><span class="line"></span><br><span class="line">MethodTableLookup &#x2F;&#x2F;æ–¹æ³•è¡¨æŸ¥è¯¢</span><br><span class="line">TailCallFunctionPointer x17 &#x2F;&#x2F;é€šè¿‡æŒ‡é’ˆè°ƒç”¨æ–¹æ³•</span><br><span class="line"></span><br><span class="line">END_ENTRY __objc_msgSend_uncached</span><br></pre></td></tr></table></figure>

<p>éç¼“å­˜çš„æ–¹å¼ï¼Œå‘é€æ¶ˆæ¯ï¼Œå…ˆè¿›è¡Œ <code>MethodTableLookup</code> æ–¹æ³•è¡¨æŸ¥è¯¢ã€‚</p>
<h4 id="MethodTableLookup-æ–¹æ³•è¡¨æŸ¥è¯¢"><a href="#MethodTableLookup-æ–¹æ³•è¡¨æŸ¥è¯¢" class="headerlink" title="MethodTableLookup æ–¹æ³•è¡¨æŸ¥è¯¢"></a>MethodTableLookup æ–¹æ³•è¡¨æŸ¥è¯¢</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.macro MethodTableLookup</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; push frame</span><br><span class="line">	SignLR</span><br><span class="line">	stp	fp, lr, [sp, #-16]!</span><br><span class="line">	mov	fp, sp</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; save parameter registers: x0..x8, q0..q7</span><br><span class="line">	sub	sp, sp, #(10*8 + 8*16)</span><br><span class="line">	stp	q0, q1, [sp, #(0*16)]</span><br><span class="line">	stp	q2, q3, [sp, #(2*16)]</span><br><span class="line">	stp	q4, q5, [sp, #(4*16)]</span><br><span class="line">	stp	q6, q7, [sp, #(6*16)]</span><br><span class="line">	stp	x0, x1, [sp, #(8*16+0*8)]</span><br><span class="line">	stp	x2, x3, [sp, #(8*16+2*8)]</span><br><span class="line">	stp	x4, x5, [sp, #(8*16+4*8)]</span><br><span class="line">	stp	x6, x7, [sp, #(8*16+6*8)]</span><br><span class="line">	str	x8,     [sp, #(8*16+8*8)]</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; lookUpImpOrForward(obj, sel, cls, LOOKUP_INITIALIZE | LOOKUP_RESOLVER)</span><br><span class="line">	&#x2F;&#x2F; receiver and selector already in x0 and x1</span><br><span class="line">	mov	x2, x16</span><br><span class="line">	mov	x3, #3</span><br><span class="line">	bl	_lookUpImpOrForward &#x2F;&#x2F;æŸ¥æ‰¾impæˆ–è€…æ¶ˆæ¯è½¬å‘</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; IMP in x0</span><br><span class="line">	mov	x17, x0</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; restore registers and return</span><br><span class="line">	ldp	q0, q1, [sp, #(0*16)]</span><br><span class="line">	ldp	q2, q3, [sp, #(2*16)]</span><br><span class="line">	ldp	q4, q5, [sp, #(4*16)]</span><br><span class="line">	ldp	q6, q7, [sp, #(6*16)]</span><br><span class="line">	ldp	x0, x1, [sp, #(8*16+0*8)]</span><br><span class="line">	ldp	x2, x3, [sp, #(8*16+2*8)]</span><br><span class="line">	ldp	x4, x5, [sp, #(8*16+4*8)]</span><br><span class="line">	ldp	x6, x7, [sp, #(8*16+6*8)]</span><br><span class="line">	ldr	x8,     [sp, #(8*16+8*8)]</span><br><span class="line"></span><br><span class="line">	mov	sp, fp</span><br><span class="line">	ldp	fp, lr, [sp], #16</span><br><span class="line">	AuthenticateLR</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯æ±‡ç¼–å®ï¼Œçœ‹çš„å‡ºæ¥ä¸­é—´è°ƒç”¨äº†ä¸€ä¸ªæ–¹æ³•<code>_lookUpImpOrForward</code>ï¼ŒæŸ¥æ‰¾impæˆ–è€…æ¶ˆæ¯è½¬å‘ã€‚</p>
<h4 id="lookUpImpOrForward-æŸ¥æ‰¾impæˆ–è€…æ¶ˆæ¯è½¬"><a href="#lookUpImpOrForward-æŸ¥æ‰¾impæˆ–è€…æ¶ˆæ¯è½¬" class="headerlink" title="_lookUpImpOrForward æŸ¥æ‰¾impæˆ–è€…æ¶ˆæ¯è½¬"></a>_lookUpImpOrForward æŸ¥æ‰¾impæˆ–è€…æ¶ˆæ¯è½¬</h4><p>é€šè¿‡å…¨å±€æœç´¢<code>_lookUpImpOrForward</code>ï¼Œå‘ç°åªæœ‰è°ƒç”¨ï¼Œæ²¡æœ‰å®ç°ï¼Œä»€ä¹ˆæƒ…å†µï¼Ÿ</p>
<blockquote>
<p> æ±‡ç¼–ä¸­è°ƒç”¨Cä¸­çš„å‡½æ•°ï¼Œå‡½æ•°åå‰åŠ ä¸‹åˆ’çº¿â€œ_â€,ä¹Ÿç®—æ˜¯çº¦å®šä¿—æˆï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ç¬¦å·åå†²çªï¼Œå› ä¸ºåœ¨ä¸€ä¸ªç¨‹åºä¸­å¾€å¾€æ˜¯åŒ…å«æ±‡ç¼–å’ŒCæ–‡ä»¶çš„ï¼Œæ±‡ç¼–ç”¨äºå¯åŠ¨éƒ¨åˆ†ï¼ŒCæ–‡ä»¶ç”¨äºåº”ç”¨ç¨‹åºï¼Œæœ€ç»ˆé€šè¿‡ç¼–è¯‘å™¨å®ç°ç¼–è¯‘ï¼Œå¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œæ±‡ç¼–å’ŒCæ˜¯ä¸€è§†åŒä»çš„ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœåœ¨æ±‡ç¼–å’ŒCæ–‡ä»¶ä¸­ä½¿ç”¨äº†åŒä¸€ä¸ªåå­—ï¼Œè¿™æ˜¯å¾ˆå¯èƒ½å‡ºç°çš„ï¼Œæ¯•ç«Ÿæ±‡ç¼–ç›¸å½“äºæœºå™¨ç ä¹Ÿç®—æ˜¯ç¨å¾®é«˜çº§çš„è¯­è¨€ï¼Œåœ¨å®šä¹‰å­ç¨‹åºæˆ–å‡½æ•°æ—¶ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨è‹±æ–‡æ‹¼å†™çš„ï¼Œè€ŒCæ–‡ä»¶ä¸­ï¼Œæ›´ä¼šä¹ æƒ¯ç”¨è‹±æ–‡æ‹¼å†™ã€‚<br>æ‰€ä»¥ä¸ºäº†é˜²æ­¢ç±»ä¼¼çš„ç¬¦å·å å†²çªï¼ŒUNIXä¸‹çš„Cè¯­è¨€å°±è§„å®šï¼ŒCè¯­è¨€çš„æºä»£ç æ–‡ä»¶ä¸­çš„æ‰€æœ‰å…¨å±€å˜é‡å’Œå‡½æ•°ç»è¿‡ç¼–è¯‘åï¼Œç›¸åº”çš„ç¬¦å·åå‰é¢ä¼šè‡ªåŠ¨çš„åŠ ä¸Šä¸‹åˆ’çº¿â€œ_â€ã€‚è¿™æ ·åšçš„å¥½å¤„ï¼Œå°±æ˜¯æ–¹ä¾¿æ˜¯ç¨‹åºå¼€å‘äººå‘˜ï¼Œä¸ç”¨å¤ªå°å¿ƒç¿¼ç¿¼çš„èµ·åï¼Œé¿å…äº†ä¸æ±‡ç¼–æ–‡ä»¶ä¸­çš„ç¬¦å·åçš„å†²çªã€‚</p>
</blockquote>
<p>ç»§ç»­å…¨å±€æœç´¢ <code>lookUpImpOrForward</code>ï¼Œæ‰¾åˆ°å‡½æ•°å®ç°ï¼Œ<code>objc-runtime-old.mm</code> ä¸­å®ç°çš„æ˜¯è€çš„æ–¹æ³•ï¼Œ<code>Objective-C 2.0</code> ä¹‹åå°±åºŸå¼ƒäº†ï¼Œ<code>objc-runtime-new.mm</code> ä¸­æ˜¯ <code>2.0</code>çš„å®ç°ã€‚</p>
<p>å…ˆçœ‹å‡½æ•°è¯´æ˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* lookUpImpOrForward.</span><br><span class="line">* The standard IMP lookup.</span><br><span class="line">* æ ‡å‡†impæŸ¥æ‰¾</span><br><span class="line">*</span><br><span class="line">* Without LOOKUP_INITIALIZE: tries to avoid +initialize (but sometimes fails)</span><br><span class="line">* å¦‚æœæ²¡æœ‰ LOOKUP_INITIALIZEï¼ˆæŸ¥æ‰¾åˆå§‹åŒ–ï¼‰ï¼šå°è¯•å»é¿å…è°ƒç”¨ +initialize æ–¹æ³• ï¼ˆä½†æ˜¯ç»å¸¸ä¼šå¤±è´¥ï¼Œè€Œé¿å…ä¸äº†ï¼‰</span><br><span class="line">*</span><br><span class="line">* Without LOOKUP_CACHE: skips optimistic unlocked lookup (but uses cache elsewhere)</span><br><span class="line">* å¦‚æœæ²¡æœ‰ LOOKUP_CACHE ï¼ˆæŸ¥æ‰¾ç¼“å­˜ï¼‰ï¼šè·³è¿‡å¼€æ”¾å¼è§£é”æŸ¥æ‰¾ ï¼ˆä½†æ˜¯åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ç¼“å­˜ï¼‰</span><br><span class="line">*</span><br><span class="line">* Most callers should use LOOKUP_INITIALIZE and LOOKUP_CACHE</span><br><span class="line">* inst is an instance of cls or a subclass thereof, or nil if none is known. </span><br><span class="line">*   If cls is an un-initialized metaclass then a non-nil inst is faster.</span><br><span class="line">* May return _objc_msgForward_impcache. IMPs destined for external use </span><br><span class="line">*   must be converted to _objc_msgForward or _objc_msgForward_stret.</span><br><span class="line">*   If you don&#39;t want forwarding at all, use LOOKUP_NIL.</span><br><span class="line">*</span><br><span class="line">* å¤§éƒ¨åˆ†è°ƒç”¨è€…åº”è¯¥ä½¿ç”¨ LOOKUP_INITIALIZE å’Œ LOOKUP_CACHE çš„å®ä¾‹ï¼Œä»–ä»¬æ˜¯å…³äºç±»ä¸å­ç±»çš„å®ä¾‹ï¼Œæˆ–è€… è¢«çŸ¥é“æ˜¯nilã€‚</span><br><span class="line">* å¦‚æœç±»æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å…ƒç±»ï¼Œæ¯”ä¸€ä¸ªénilçš„å®ä¾‹æ›´å¿«ã€‚</span><br><span class="line">* å¯èƒ½è¿”å›_objc_msgForward_impcacheã€‚</span><br><span class="line">* æä¾›ç»™å¤–éƒ¨ä½¿ç”¨çš„imps,å¿…é¡»è¢«è½¬æ¢æˆ _objc_msgForward æˆ–è€… _objc_msgForward_stretã€‚</span><br><span class="line">* å¦‚æœä½ ä¸€ç‚¹ä¹Ÿä¸å¸Œæœ›è½¬å‘ï¼Œä½¿ç”¨ LOOKUP_NILï¼ˆæŸ¥æ‰¾ç©ºï¼‰ã€‚</span><br><span class="line">*</span><br><span class="line">**********************************************************************&#x2F;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹ä¸‹å®é™…ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">IMP lookUpImpOrForward(id inst, SEL sel, Class cls, int behavior)</span><br><span class="line">&#123;</span><br><span class="line">    const IMP forward_imp &#x3D; (IMP)_objc_msgForward_impcache;</span><br><span class="line">    IMP imp &#x3D; nil;</span><br><span class="line">    Class curClass;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertUnlocked();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Optimistic cache lookup</span><br><span class="line">    &#x2F;&#x2F; ä¹è§‚ç¼“å­˜æŸ¥æ‰¾</span><br><span class="line">    if (fastpath(behavior &amp; LOOKUP_CACHE)) &#123; &#x2F;&#x2F; å¦‚æœæœ‰ç¼“å­˜æŸ¥æ‰¾æ ‡è®°ï¼Œè¿›è¡Œç¼“å­˜æŸ¥æ‰¾</span><br><span class="line">        imp &#x3D; cache_getImp(cls, sel);</span><br><span class="line">        if (imp) goto done_nolock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; runtimeLock is held during isRealized and isInitialized checking</span><br><span class="line">    &#x2F;&#x2F; to prevent races against concurrent realization.</span><br><span class="line">    &#x2F;&#x2F; åœ¨å®ç°å’Œåˆå§‹åŒ–æ£€æŸ¥æœŸé—´æŒæœ‰runtimeLock,æ˜¯é˜²æ­¢å¹¶å‘å®ç°ä¹‹é—´çš„ç«äº‰ã€‚</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; runtimeLock is held during method search to make</span><br><span class="line">    &#x2F;&#x2F; method-lookup + cache-fill atomic with respect to method addition.</span><br><span class="line">    &#x2F;&#x2F; Otherwise, a category could be added but ignored indefinitely because</span><br><span class="line">    &#x2F;&#x2F; the cache was re-filled with the old value after the cache flush on</span><br><span class="line">    &#x2F;&#x2F; behalf of the category.</span><br><span class="line">    &#x2F;&#x2F; åœ¨æ–¹æ³•æœç´¢æœŸé—´ä¿æŒçš„ runtimeLockï¼Œä½¿ method-lookup + cache-fillä¿æŒåŸå­æ€§ï¼Œç›¸å¯¹äºæ–¹æ³•æ·»åŠ ã€‚</span><br><span class="line">    &#x2F;&#x2F; å¦å¤–ï¼Œä¸€ä¸ªå¯ä»¥æ·»åŠ çš„ç±»åˆ«ï¼Œåº”è¯¥æ— é™æœŸåœ°å¿½ç•¥å®ƒï¼Œå› ä¸ºç±»åˆ«çš„ç¼“å­˜åˆ·æ–°ä¹‹åï¼Œç¼“å­˜è¢«é‡æ–°å¡«å……ä¸ºåŸæ¥çš„æ—§å€¼ã€‚</span><br><span class="line"></span><br><span class="line">    runtimeLock.lock();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; We don&#39;t want people to be able to craft a binary blob that looks like</span><br><span class="line">    &#x2F;&#x2F; a class but really isn&#39;t one and do a CFI attack.</span><br><span class="line">    &#x2F;&#x2F; æˆ‘ä»¬ä¸å¸Œæœ›äººä»¬èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªçœ‹èµ·æ¥åƒç±»ä½†å®é™…ä¸Šä¸æ˜¯ç±»çš„äºŒè¿›åˆ¶å¤§å¯¹è±¡ï¼Œå¹¶è¿›è¡ŒCFIæ”»å‡»ã€‚</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; To make these harder we want to make sure this is a class that was</span><br><span class="line">    &#x2F;&#x2F; either built into the binary or legitimately registered through</span><br><span class="line">    &#x2F;&#x2F; objc_duplicateClass, objc_initializeClassPair or objc_allocateClassPair.</span><br><span class="line">    &#x2F;&#x2F; ä¸ºäº†å¢åŠ éš¾åº¦ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™æ˜¯ä¸€ä¸ªå†…å»ºåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ç±»ï¼Œ</span><br><span class="line">    &#x2F;&#x2F; æˆ–è€…æ˜¯é€šè¿‡objc_duplicateClassã€objc_initializeClassPairæˆ–objc_allocateClassPairåˆæ³•æ³¨å†Œçš„ç±»ã€‚</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; TODO: this check is quite costly during process startup.</span><br><span class="line">    &#x2F;&#x2F; TODO: è¿™ç§æ£€æŸ¥åœ¨è¿›ç¨‹å¯åŠ¨æœŸé—´éå¸¸æ˜‚è´µã€‚</span><br><span class="line">    checkIsKnownClass(cls);</span><br><span class="line"></span><br><span class="line">    if (slowpath(!cls-&gt;isRealized())) &#123; &#x2F;&#x2F;ç±»æ˜¯å¦è¢«å®ç°äº†</span><br><span class="line">        &#x2F;&#x2F;å®ç°ç±»ï¼Œä¹Ÿå¯èƒ½æ˜¯swiftçš„ç±»</span><br><span class="line">        cls &#x3D; realizeClassMaybeSwiftAndLeaveLocked(cls, runtimeLock);</span><br><span class="line">        &#x2F;&#x2F; runtimeLock may have been dropped but is now locked again</span><br><span class="line">        &#x2F;&#x2F; runtimeLockå¯èƒ½å·²ç»è¢«åˆ é™¤ï¼Œä½†ç°åœ¨åˆè¢«é”å®šäº†</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (slowpath((behavior &amp; LOOKUP_INITIALIZE) &amp;&amp; !cls-&gt;isInitialized())) &#123;</span><br><span class="line">        &#x2F;&#x2F;åˆå§‹åŒ–ç±»</span><br><span class="line">        cls &#x3D; initializeAndLeaveLocked(cls, inst, runtimeLock);</span><br><span class="line">        &#x2F;&#x2F; runtimeLock may have been dropped but is now locked again</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; If sel &#x3D;&#x3D; initialize, class_initialize will send +initialize and </span><br><span class="line">        &#x2F;&#x2F; then the messenger will send +initialize again after this </span><br><span class="line">        &#x2F;&#x2F; procedure finishes. Of course, if this is not being called </span><br><span class="line">        &#x2F;&#x2F; from the messenger then it won&#39;t happen. 2778172</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœsel &#x3D;&#x3D; initialize, class_initializeå°†å‘é€+initializeï¼Œ</span><br><span class="line">        &#x2F;&#x2F; ç„¶ååœ¨æ­¤è¿‡ç¨‹å®Œæˆåï¼Œmessengerå°†å†æ¬¡å‘é€+initializeã€‚</span><br><span class="line">        &#x2F;&#x2F; å½“ç„¶ï¼Œå¦‚æœè¿™ä¸æ˜¯ä»messengerè°ƒç”¨çš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¸ä¼šå‘ç”Ÿã€‚2778172</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    curClass &#x3D; cls;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; The code used to lookup the class&#39;s cache again right after</span><br><span class="line">    &#x2F;&#x2F; we take the lock but for the vast majority of the cases</span><br><span class="line">    &#x2F;&#x2F; evidence shows this is a miss most of the time, hence a time loss.</span><br><span class="line">    &#x2F;&#x2F; åœ¨é”å®šä¹‹åï¼Œç”¨äºå†æ¬¡æŸ¥æ‰¾ç±»ç¼“å­˜çš„ä»£ç ï¼Œä½†æ˜¯å¯¹äºç»å¤§å¤šæ•°æƒ…å†µï¼Œ</span><br><span class="line">    &#x2F;&#x2F; æœ‰è¯æ®è¡¨æ˜è¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯é”™è¯¯çš„ï¼Œå› æ­¤æ˜¯æ—¶é—´æŸå¤±ã€‚</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; The only codepath calling into this without having performed some</span><br><span class="line">    &#x2F;&#x2F; kind of cache lookup is class_getInstanceMethod().</span><br><span class="line">    &#x2F;&#x2F; æƒŸä¸€è°ƒç”¨å®ƒè€Œæ²¡æœ‰æ‰§è¡ŒæŸç§ç¼“å­˜æŸ¥æ‰¾çš„ä»£ç è·¯å¾„æ˜¯class_getInstanceMethod()ã€‚</span><br><span class="line"></span><br><span class="line">    for (unsigned attempts &#x3D; unreasonableClassCount();;) &#123;&#x2F;&#x2F;ä¸€ä¸ªé˜²æ­¢å¾ªç¯è‡ªæ—‹çš„æ•°</span><br><span class="line">        &#x2F;&#x2F; curClass method list.</span><br><span class="line">        &#x2F;&#x2F; ä»å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨æŸ¥æ‰¾ã€‚</span><br><span class="line">        Method meth &#x3D; getMethodNoSuper_nolock(curClass, sel);</span><br><span class="line">        if (meth) &#123; &#x2F;&#x2F;æ‰¾åˆ°ç›´æ¥è¿”å›</span><br><span class="line">            imp &#x3D; meth-&gt;imp;</span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (slowpath((curClass &#x3D; curClass-&gt;superclass) &#x3D;&#x3D; nil)) &#123;</span><br><span class="line">            &#x2F;&#x2F; No implementation found, and method resolver didn&#39;t help.</span><br><span class="line">            &#x2F;&#x2F; Use forwarding.</span><br><span class="line">            &#x2F;&#x2F; æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œè€Œä¸”æ–¹æ³•è§£æå™¨æ²¡æœ‰ä½œç”¨ï¼Œè¿›è¡Œæ–¹æ³•è½¬å‘</span><br><span class="line">            imp &#x3D; forward_imp;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Halt if there is a cycle in the superclass chain.</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœè¶…ç±»é“¾ä¸­æœ‰ä¸€ä¸ªå¾ªç¯ï¼Œåˆ™åœæ­¢</span><br><span class="line">        if (slowpath(--attempts &#x3D;&#x3D; 0)) &#123;</span><br><span class="line">            _objc_fatal(&quot;Memory corruption in class list.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Superclass cache.</span><br><span class="line">        &#x2F;&#x2F; ä»çˆ¶ç±»çš„ç¼“å­˜æŸ¥æ‰¾</span><br><span class="line">        imp &#x3D; cache_getImp(curClass, sel);&#x2F;&#x2F;è¿™æ˜¯ä¸ªæ±‡ç¼–æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨CacheLookUp</span><br><span class="line">        if (slowpath(imp &#x3D;&#x3D; forward_imp)) &#123;</span><br><span class="line">            &#x2F;&#x2F; Found a forward:: entry in a superclass.</span><br><span class="line">            &#x2F;&#x2F; Stop searching, but don&#39;t cache yet; call method</span><br><span class="line">            &#x2F;&#x2F; resolver for this class first.</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        if (fastpath(imp)) &#123;</span><br><span class="line">            &#x2F;&#x2F; Found the method in a superclass. Cache it in this class.</span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; No implementation found. Try method resolver once.</span><br><span class="line">    &#x2F;&#x2F; æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œå°è¯•æ–¹æ³•è§£æå™¨</span><br><span class="line">    if (slowpath(behavior &amp; LOOKUP_RESOLVER)) &#123;</span><br><span class="line">        behavior ^&#x3D; LOOKUP_RESOLVER;</span><br><span class="line">        return resolveMethod_locked(inst, sel, cls, behavior);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> done:</span><br><span class="line">    log_and_fill_cache(cls, imp, sel, inst, curClass);&#x2F;&#x2F;æ‰¾åˆ°åï¼Œæ ‡è®°å’Œæ”¾åˆ°ç¼“å­˜ã€‚</span><br><span class="line">    runtimeLock.unlock();</span><br><span class="line"> done_nolock:</span><br><span class="line">    if (slowpath((behavior &amp; LOOKUP_NIL) &amp;&amp; imp &#x3D;&#x3D; forward_imp)) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœæœ‰ <code>LOOKUP_CACHE</code> æ ‡è®°ï¼Œè¿›è¡Œç¼“å­˜æŸ¥æ‰¾ã€‚</li>
<li>æ£€æµ‹æ˜¯å¦æ˜¯å·²çŸ¥çš„ç±»</li>
<li>åˆ¤æ–­ç±»æ˜¯å¦å·²ç»å®ç°ï¼Œå¦‚æœæ²¡å®ç°ï¼Œå®ç°ç±»ï¼ˆä¹Ÿæœ‰è‚¯æ˜¯swiftçš„ç±»ï¼‰</li>
<li>å¦‚æœæœ‰ <code>LOOKUP_INITIALIZE</code> æ ‡è®°ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–ã€‚<ul>
<li>å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿›è¡Œç±»åˆå§‹åŒ–ï¼Œè¿™æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„ <code>+initialize</code>æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>è¿›è¡Œæ–¹æ³•çš„å¾ªç¯æŸ¥æ‰¾ã€‚<ul>
<li>ä»ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ã€‚<ul>
<li>å¦‚æœæ‰¾åˆ°ï¼Œè·³è½¬åˆ° <code>done</code>ã€‚</li>
</ul>
</li>
<li>æœªæ‰¾åˆ°ï¼Œ<code>curClass</code> æŒ‡å‘ çˆ¶ç±»ã€‚<ul>
<li>å¦‚æœçˆ¶ç±»æ˜¯nilï¼Œè¯´æ˜æŸ¥æ‰¾å¤±è´¥ï¼Œè¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼Œå¹¶è·³å‡ºå¾ªç¯ã€‚</li>
</ul>
</li>
<li>ä»çˆ¶ç±»çš„ç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚</li>
<li>å¦‚æœ æ–¹æ³• == <code>forward_imp</code>ï¼Œ è·³å‡ºå¾ªç¯ã€‚</li>
<li>å¦‚æœæ‰¾åˆ°ï¼Œè·³è½¬åˆ° <code>done</code>ã€‚</li>
</ul>
</li>
<li>å¦‚æœæœ‰ <code>LOOKUP_RESOLVER</code>, è¿”å› æ–¹æ³•è§£æã€‚</li>
<li><code>done</code> <ul>
<li>æ ‡è®°æ–¹æ³•å¹¶æ”¾åˆ°ç¼“å­˜ã€‚</li>
</ul>
</li>
<li><code>done_nolock</code><ul>
<li>å¦‚æœæœ‰ <code>LOOKUP_NIL</code> æ ‡è®°ï¼Œå¹¶ä¸” æ–¹æ³• == <code>forward_imp</code>ï¼Œè¿”å› nilã€‚</li>
</ul>
</li>
<li>è¿”å›æ–¹æ³•impã€‚</li>
</ul>
<p>ä¸Šé¢æ˜¯æ•´ä¸ªæ–¹æ³•æŸ¥æ‰¾æµç¨‹ï¼Œå…ˆæ‰¾ç¼“å­˜ï¼Œå†æ‰¾æ–¹æ³•åˆ—è¡¨ï¼Œç„¶åå»çˆ¶ç±»çš„ç¼“å­˜æŸ¥æ‰¾ï¼Œå†æ¬¡æ˜¯çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼ŒçŸ¥é“çˆ¶ç±»æ˜¯nilï¼ŒæŸ¥æ‰¾å¤±è´¥ï¼Œè§¦å‘æ¶ˆæ¯è½¬å‘ã€‚<br>é¦–æ¬¡æŸ¥æ‰¾çš„æ—¶å€™ï¼Œä¼šæœ‰ <code>LOOKUP_RESOLVER</code>æ ‡è®°ï¼Œæ‰¾ä¸åˆ°çš„æ—¶å€™ï¼Œä¼šè§¦å‘ <code>resolveMethod_locked</code>æ–¹æ³•è§£æï¼Œæ•´ä¸ªå‡½æ•°ä¼šè°ƒç”¨ç±»çš„ <code>+resolveInstanceMethod:</code>æˆ–è€… <code>+resolveClassMethod:</code>ï¼Œç„¶åå†è¿›è¡Œä¸€æ¬¡æ–¹æ³•æŸ¥æ‰¾ <code>lookUpImpOrForward</code>ï¼Œè¿™æ¬¡å°±æ²¡æœ‰ <code>LOOKUP_RESOLVER</code>æ ‡è®°äº†ã€‚</p>
<h4 id="objc-msgForward-æ–¹æ³•è½¬å‘"><a href="#objc-msgForward-æ–¹æ³•è½¬å‘" class="headerlink" title="_objc_msgForward æ–¹æ³•è½¬å‘"></a>_objc_msgForward æ–¹æ³•è½¬å‘</h4><ul>
<li>å½“æ–¹æ³•æŸ¥æ‰¾å¤±è´¥çš„æ—¶å€™ï¼Œè§¦å‘æ¶ˆæ¯è½¬å‘ <code>_objc_msgForward_impcache</code>ï¼Œè€Œ <code>_objc_msgForward_impcache</code> å†…éƒ¨æ±‡ç¼–å®ç°ï¼Œç›´æ¥è°ƒç”¨çš„ <code>__objc_msgForward</code>ã€‚</li>
<li><code>__objc_msgForward</code> å†…éƒ¨å®ç°ï¼Œè°ƒç”¨äº† <code>__objc_forward_handler</code>ã€‚</li>
</ul>
<h4 id="objc-forward-handler-æ–¹æ³•è½¬å‘å¥æŸ„"><a href="#objc-forward-handler-æ–¹æ³•è½¬å‘å¥æŸ„" class="headerlink" title="_objc_forward_handler æ–¹æ³•è½¬å‘å¥æŸ„"></a>_objc_forward_handler æ–¹æ³•è½¬å‘å¥æŸ„</h4><p>è¿™æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ ¹æ®å®å®šä¹‰ï¼Œæœ‰ä¸åŒçš„å®ç°ï¼Œç ”ç©¶ç‰ˆæœ¬æ˜¯ <code>Objective-C 2.0</code>ï¼Œæ‰€ä»¥æ˜¯ <code>__OBJC2__</code> å¯¹åº”çš„å®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#if !__OBJC2__</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Default forward handler (nil) goes to forward:: dispatch.</span><br><span class="line">void *_objc_forward_handler &#x3D; nil;</span><br><span class="line">void *_objc_forward_stret_handler &#x3D; nil;</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Default forward handler halts the process.</span><br><span class="line">__attribute__((noreturn, cold)) void</span><br><span class="line">objc_defaultForwardHandler(id self, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot;</span><br><span class="line">                &quot;(no message forward handler is installed)&quot;, </span><br><span class="line">                class_isMetaClass(object_getClass(self)) ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                object_getClassName(self), sel_getName(sel), self);</span><br><span class="line">&#125;</span><br><span class="line">void *_objc_forward_handler &#x3D; (void*)objc_defaultForwardHandler;</span><br><span class="line"></span><br><span class="line">#if SUPPORT_STRET</span><br><span class="line">struct stret &#123; int i[100]; &#125;;</span><br><span class="line">__attribute__((noreturn, cold)) struct stret</span><br><span class="line">objc_defaultForwardStretHandler(id self, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    objc_defaultForwardHandler(self, sel);</span><br><span class="line">&#125;</span><br><span class="line">void *_objc_forward_stret_handler &#x3D; (void*)objc_defaultForwardStretHandler;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p><code>void *_objc_forward_handler = (void*)objc_defaultForwardHandler</code>ï¼Œè¡¨ç¤ºæœ€åçš„å®ç°æ˜¯ <code>objc_defaultForwardHandler</code>ï¼Œåœ¨é‡Œé¢æˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„ <code>unrecognized selector sent to instance</code> æœªå®šä¹‰çš„é”™è¯¯æ‰“å°ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><img src="/images/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81-%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<p>ç²¾ç®€æ­¥éª¤ä¸ºï¼š</p>
<ol>
<li>ç©ºæŒ‡é’ˆæ£€æµ‹</li>
<li>ç¼“å­˜å¿«é€ŸæŸ¥æ‰¾</li>
<li>éç¼“å­˜çš„æ…¢é€ŸæŸ¥æ‰¾ï¼ˆæ–¹æ³•åˆ—è¡¨æŸ¥è¯¢ï¼‰<ol>
<li>æ£€æµ‹ç±»å®ç°</li>
<li>æ£€æµ‹ç±»åˆå§‹åŒ–</li>
<li>ä»å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨æŸ¥æ‰¾ï¼Œæ‰¾æ‰“è·³è½¬åˆ°<code>10</code>ï¼Œæœªæ‰¾åˆ°è·³è½¬<code>4</code></li>
<li>å°†å½“å‰ç±»æŒ‡å‘çˆ¶ç±»ï¼Œå¦‚æœçˆ¶ç±»ä¸ºç©ºï¼Œimp = forward_impï¼Œè·³è½¬åˆ°<code>7</code>ï¼Œä¸ä¸ºç©ºï¼Œè·³è½¬<code>5</code></li>
<li>æŸ¥æ‰¾çˆ¶ç±»çš„ç¼“å­˜ï¼Œæ‰¾æ‰“è·³è½¬åˆ°<code>10</code>ï¼Œæœªæ‰¾åˆ°è·³è½¬<code>6</code></li>
<li>è·³è½¬åˆ°3</li>
<li>æŸ¥æ‰¾ç»“æŸ</li>
<li>æ£€æµ‹LOOKUP_RESOLVERï¼Œæœ‰ï¼Œè·³è½¬åˆ°<code>9</code>ï¼Œæ²¡æœ‰è·³è½¬åˆ°<code>10</code></li>
<li>æ–¹æ³•è§£æ<ol>
<li>æ˜¯å¦å…ƒç±»ï¼Œæ˜¯è·³è½¬åˆ°2ï¼Œä¸æ˜¯è·³è½¬åˆ°<code>4</code></li>
<li>è°ƒç”¨<code>+resolveClassMethod</code></li>
<li>å¿«é€Ÿç¼“å­˜æŸ¥æ‰¾ï¼Œæ‰¾åˆ°è·³è½¬åˆ°<code>5</code>ï¼Œæœªæ‰¾åˆ°è·³è½¬åˆ°<code>4</code></li>
<li>è°ƒç”¨<code>+resolveInstanceMethod</code></li>
<li>å¸¦æœ‰ç¼“å­˜æ ‡è®°çš„æ™®é€šæŸ¥æ‰¾ã€‚</li>
</ol>
</li>
<li>æ ‡è®°å¹¶ç¼“å­˜imp</li>
<li>è¿”å›imp</li>
</ol>
</li>
<li>impæ˜¯æ™®é€šimpï¼Œç›´æ¥è°ƒç”¨ã€‚</li>
<li>impæ˜¯forward_impï¼Œå®é™…å®ç°æ˜¯<code>_objc_forward_handler</code>ï¼ŒæŒ‡å‘çš„æ˜¯<code>objc_defaultForwardHandler</code>ï¼Œæ‰“å°æ¶ˆæ¯ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ol>
<blockquote>
<p>ä»ä¸Šé¢çš„æ­¥éª¤çœ‹å‡ºï¼Œå½“æ–¹æ³•æœªæ‰¾åˆ°æ—¶ï¼Œæºç ä¸­åªè§¦å‘äº†ï¼Œæ¶ˆæ¯è½¬å‘çš„ç¬¬ä¸€æ­¥ï¼Œ<strong>åŠ¨æ€è§£æ</strong>ï¼Œå³<code>+resolveClassMethod</code>ã€<code>+resolveInstanceMethod</code>ï¼Œå¹¶æ²¡æœ‰åç»­çš„ï¼Œ<strong>å¿«é€Ÿè½¬å‘</strong>ï¼Œä»¥åŠ<strong>æ™®é€šè½¬å‘é˜¶æ®µ</strong>ï¼Œå¤§æ¦‚æ˜¯åœ¨<code>Foundation</code>ä¸­åšäº†ï¼Œ<code>_objc_forward_handler</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œåç»­æ˜¯å¯ä»¥è¢«èµ‹å€¼æ”¹å˜çš„ã€‚</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
